test_cli_config:
  -
    id: argparse
    app:
      > class MyApp:
      >
      >     @byoc.configs
      >     def iter_configs(self):
      >         yield ArgparseConfig(self.get_argparse)
      >
      >     usage = byoc.config_attr(CliConfig)
      >     brief = byoc.config_attr(CliConfig)
      >
      >     x = byoc.param(Key(CliConfig, 'x'))
      >     y = byoc.param(Key(CliConfig, 'y'), Value(False))
      >
      >     def get_argparse(self):
      >         import argparse
      >         p = argparse.ArgumentParser(description="Do something")
      >         p.add_argument('x', type=int)
      >         p.add_argument('-y', action='store_true')
      >         return p
    usage:
      > usage: app [-h] [-y] x
      >
      > Do something
      >
      > positional arguments:
      >   x
      >
      > optional arguments:
      >   -h, --help  show this help message and exit
      >   -y
      >
    brief:
      > Do something
    invocations:
      -
        argv:
          > ./app 1
        expected:
          x: 1
          y: False
      -
        argv:
          > ./app 1 -y
        expected:
          x: 1
          y: True
  -
    id: argparse-unspecified-?
    app:
      > class MyApp:
      >
      >     @byoc.configs
      >     def iter_configs(self):
      >         yield ArgparseConfig(self.get_argparse)
      >
      >     x = byoc.param(Key(CliConfig, 'x'), Value('default'))
      >
      >     def get_argparse(self):
      >         import argparse
      >         p = argparse.ArgumentParser()
      >         p.add_argument('x', nargs='?', type=int)
      >         return p
    invocations:
      -
        argv:
          > ./app 
        expected:
          x: 'default'
      -
        argv:
          > ./app 1
        expected:
          x: 1
  -
    id: argparse-unspecified-*
    app:
      > class MyApp:
      >
      >     @byoc.configs
      >     def iter_configs(self):
      >         yield ArgparseConfig(self.get_argparse)
      >
      >     x = byoc.param(Key(CliConfig, 'x'), Value('default'))
      >
      >     def get_argparse(self):
      >         import argparse
      >         p = argparse.ArgumentParser()
      >         p.add_argument('x', nargs='*', type=int)
      >         return p
    invocations:
      -
        argv:
          > ./app 
        expected:
          x: 'default'
      -
        argv:
          > ./app 1
        expected:
          x: [1]
      -
        argv:
          > ./app 1 2
        expected:
          x: [1, 2]
  -
    id: argparse-unspecified-flag
    app:
      > class MyApp:
      >
      >     @byoc.configs
      >     def iter_configs(self):
      >         yield ArgparseConfig(self.get_argparse)
      >
      >     x = byoc.param(Key(CliConfig, 'x'), Value('default'))
      >
      >     def get_argparse(self):
      >         import argparse
      >         p = argparse.ArgumentParser()
      >         p.add_argument('-x', action='store_true')
      >         return p
    invocations:
      -
        argv:
          > ./app 
        expected:
          x: 'default'
      -
        argv:
          > ./app -x
        expected:
          x: True
  -
    id: argparse-unspecified-option
    app:
      > class MyApp:
      >
      >     @byoc.configs
      >     def iter_configs(self):
      >         yield ArgparseConfig(self.get_argparse)
      >
      >     x = byoc.param(Key(CliConfig, 'x'), Value('default'))
      >
      >     def get_argparse(self):
      >         import argparse
      >         p = argparse.ArgumentParser()
      >         p.add_argument('-x', type=int)
      >         return p
    invocations:
      -
        argv:
          > ./app 
        expected:
          x: 'default'
      -
        argv:
          > ./app -x 1
        expected:
          x: 1
  -
    id: argparse-schema
    # Use a schema that only changes keys, not values.  The former is a more 
    # complicated case, because the schema needs to account for the metadata as 
    # well.  But there are tests for that in `test_load.nt`, so we don't need 
    # to repeat them here.
    app:
      > def plus_1(d):
      >     return {k: v + 1 for k, v in d.items()}
      >     
      > class MyApp:
      >
      >     @byoc.configs
      >     def iter_configs(self):
      >         yield ArgparseConfig(
      >             parser=self.get_argparse,
      >             schema=plus_1,
      >         )
      >
      >     x = byoc.param(Key(CliConfig, 'x'))
      >
      >     def get_argparse(self):
      >         import argparse
      >         p = argparse.ArgumentParser()
      >         p.add_argument('x', type=int)
      >         return p

    invocations:
      -
        argv:
          > ./app 1
        expected:
          x: 2
  -
    id: argparse-meta
    app:
      > class MyApp(MetaMixin):
      >
      >     @byoc.configs
      >     def iter_configs(self):
      >         yield ArgparseConfig(self.get_argparse)
      >
      >     x = byoc.param(Key(CliConfig, 'x'))
      >
      >     def get_argparse(self):
      >         import argparse
      >         p = argparse.ArgumentParser()
      >         p.add_argument('x', type=int)
      >         return p
    invocations:
      -
        argv:
          > ./app 1
        expected:
          x: 1
          meta.x.name: 'x'
          meta.x.value: 1
  -
    id: docopt
    app:
      > class MyApp:
      >     """\
      >     Do something.
      >
      >     Usage:
      >         app <x> [-y]
      >     """
      >
      >     @byoc.configs
      >     def iter_configs(self):
      >         yield DocoptConfig(self.__doc__)
      >
      >     usage = byoc.config_attr(CliConfig)
      >     brief = byoc.config_attr(CliConfig)
      >
      >     x = byoc.param(Key(CliConfig, '<x>', cast=int))
      >     y = byoc.param(Key(CliConfig, '-y'), Value(False))
    usage:
      > Do something.
      >
      > Usage:
      >     app <x> [-y]
      >
    brief:
      > Do something.
    invocations:
      -
        argv:
          > ./app 1
        expected:
          x: 1
          y: False
      -
        argv:
          > ./app 1 -y
        expected:
          x: 1
          y: True
  -
    id: docopt-unspecified-?
    app:
      > class MyApp:
      >     """\
      >     Do something.
      >
      >     Usage:
      >         app [<x>]
      >     """
      >
      >     @byoc.configs
      >     def iter_configs(self):
      >         yield DocoptConfig(self.__doc__)
      >
      >     x = byoc.param(Key(CliConfig, '<x>', cast=int), Value('default'))
    invocations:
      -
        argv:
          > ./app
        expected:
          x: 'default'
      -
        argv:
          > ./app 1
        expected:
          x: 1
  -
    id: docopt-unspecified-*
    app:
      > def ints(xs):
      >    return [int(x) for x in xs]
      >
      > class MyApp:
      >     """\
      >     Do something.
      >
      >     Usage:
      >         app [<x>...]
      >     """
      >
      >     @byoc.configs
      >     def iter_configs(self):
      >         yield DocoptConfig(self.__doc__)
      >
      >     x = byoc.param(Key(CliConfig, '<x>', cast=ints), Value('default'))
    invocations:
      -
        argv:
          > ./app
        expected:
          x: 'default'
      -
        argv:
          > ./app 1
        expected:
          x: [1]
      -
        argv:
          > ./app 1 2
        expected:
          x: [1, 2]
  -
    id: docopt-unspecified-flag
    app:
      > class MyApp:
      >     """\
      >     Do something.
      >
      >     Usage:
      >         app [-x]
      >     """
      >
      >     @byoc.configs
      >     def iter_configs(self):
      >         yield DocoptConfig(self.__doc__)
      >
      >     x = byoc.param(Key(CliConfig, '-x'), Value('default'))
    invocations:
      -
        argv:
          > ./app
        expected:
          x: 'default'
      -
        argv:
          > ./app -x
        expected:
          x: True
  -
    id: docopt-unspecified-option
    app:
      > class MyApp:
      >     """\
      >     Do something.
      >
      >     Usage:
      >         app [-x <x>]
      >     """
      >
      >     @byoc.configs
      >     def iter_configs(self):
      >         yield DocoptConfig(self.__doc__)
      >
      >     x = byoc.param(Key(CliConfig, '-x', cast=int), Value('default'))
    invocations:
      -
        argv:
          > ./app
        expected:
          x: 'default'
      -
        argv:
          > ./app -x 1
        expected:
          x: 1
  -
    id: docopt-version
    app:
      > class MyApp:
      >     """\
      >     Usage:
      >         app <x>
      >     """
      >
      >     @byoc.configs
      >     def iter_configs(self):
      >         yield DocoptConfig(
      >             usage=self.__doc__,
      >             version='1.0',
      >         )
      >
      >     x = byoc.param(Key(CliConfig, '<x>', cast=int))
    invocations:
      -
        argv:
          > ./app 1
        expected:
          x: 1
      -
        argv:
          > ./app --version
        error: SystemExit
        stdout:
          > 1.0
          >
  -
    id: docopt-options-first
    app:
      > class MyApp:
      >     """\
      >     Usage:
      >         app [-x] <y>...
      >     """
      >
      >     @byoc.configs
      >     def iter_configs(self):
      >         yield DocoptConfig(
      >             usage=self.__doc__,
      >             options_first=True,
      >         )
      >
      >     x = byoc.param(Key(CliConfig, '-x'), Value(False))
      >     y = byoc.param(Key(CliConfig, '<y>'))
    invocations:
      -
        argv:
          > ./app y
        expected:
          x: False
          y: ['y']
      -
        argv:
          > ./app -x y
        expected:
          x: True
          y: ['y']
      -
        argv:
          > ./app y -x
        expected:
          x: False
          y: ['y', '-x']
  -
    id: docopt-schema
    app:
      > def plus_1(d):
      >     return {k: int(v) + 1 for k, v in d.items()}
      >     
      > class MyApp:
      >     """\
      >     Usage:
      >         app <x>
      >     """
      >
      >     @byoc.configs
      >     def iter_configs(self):
      >         yield DocoptConfig(
      >             usage=self.__doc__,
      >             schema=plus_1,
      >         )
      >
      >     x = byoc.param(Key(CliConfig, '<x>'))
    invocations:
      -
        argv:
          > ./app 1
        expected:
          x: 2
  -
    id: docopt-meta
    app:
      > def ints(xs):
      >     return [int(x) for x in xs]
      >
      > class MyApp(MetaMixin):
      >     """\
      >     Usage:
      >         app <x>
      >     """
      >
      >     @byoc.configs
      >     def iter_configs(self):
      >         yield DocoptConfig(self.__doc__)
      >
      >     x = byoc.param(Key(CliConfig, '<x>', cast=int))
    invocations:
      -
        argv:
          > ./app 1
        expected:
          x: 1
          meta.x.name: '<x>'
          meta.x.value: '1'
  -
    id: docopt-mako
    app:
      > class MyApp:
      >     """\
      >     Do something.
      >
      >     Usage:
      >         app <x> [-y Y]
      >
      >     Options:
      >         -y Y  [default: ${app.y.upper()}]
      >
      >     ${details}
      >     """

      >     @byoc.configs
      >     def iter_configs(self):
      >         details = dict(details='Lorem ipsum...')
      >         usage = byoc.mako_usage(self, extra_vars=details)
      >         yield DocoptConfig(usage)
      >
      >     brief = byoc.config_attr(CliConfig)
      >     usage = byoc.config_attr(CliConfig)
      >
      >     x = byoc.param(Key(CliConfig, '<x>'))
      >     y = byoc.param(Key(CliConfig, '-y'), Value('a'))
    usage:
      > Do something.
      >
      > Usage:
      >     app <x> [-y Y]
      >
      > Options:
      >     -y Y  [default: A]
      >
      > Lorem ipsum...
      >
    brief: Do something.
    invocations:
      -
        argv:
          > ./app x
        expected:
          x: 'x'
          y: 'A'
      -
        argv:
          > ./app x -y b
        expected:
          x: 'x'
          y: 'b'

test_file_config:
  -
    id: json
    app:
      > class MyApp:
      >
      >     @byoc.configs
      >     def iter_configs(self):
      >         yield JsonConfig('x.json')
      >
      >     x = byoc.param(Key(JsonConfig, 'x'))
    tmp_files:
      x.json:
        > {"x": 1}
    expected:
      x: 1
  -
    id: nt
    app:
      > class MyApp:
      >
      >     @byoc.configs
      >     def iter_configs(self):
      >         yield NtConfig('x.nt')
      >
      >     x = byoc.param(Key(NtConfig, 'x'))
      >     y = byoc.param(Key(NtConfig, 'y', cast=int))
    tmp_files:
      x.nt:
        > x: 1
        > y: 1
    expected:
      x: '1'
      y: 1
  -
    id: toml
    app:
      > class MyApp:
      >
      >     @byoc.configs
      >     def iter_configs(self):
      >         yield TomlConfig('x.toml')
      >
      >     x = byoc.param(Key(TomlConfig, 'x'))
    tmp_files:
      x.toml:
        > x = 1
    expected:
      x: 1
  -
    id: yaml
    app:
      > class MyApp:
      >
      >     @byoc.configs
      >     def iter_configs(self):
      >         yield YamlConfig('x.yml')
      >
      >     x = byoc.param(Key(YamlConfig, 'x'))
    tmp_files:
      x.yml:
        > x: 1
    expected:
      x: 1
  -
    id: yaml-multiple-paths
    app:
      > class MyApp:
      >
      >     @byoc.configs
      >     def iter_configs(self):
      >         yield YamlConfig(['x1.yml', 'x2.yml'])
      >
      >     x = byoc.param(Key(YamlConfig, 'x'), pick=list)
    tmp_files:
      x1.yml:
        > x: 1
      x2.yml:
        > x: 2
    expected:
      x: [1, 2]
  -
    id: yaml-path-dependency
    app:
      > class MyApp:
      >
      >     @byoc.configs
      >     def iter_configs(self):
      >         yield YamlConfig(lambda: self.path)
      >
      >     x = byoc.param(Key(YamlConfig, 'x'))
      >     path = byoc.param(Value('x.yml'))
    tmp_files:
      x.yml:
        > x: 1
    expected:
      x: 1
  -
    id: yaml-skip-missing-path
    app:
      > class MyApp:
      >
      >     @byoc.configs
      >     def iter_configs(self):
      >         yield YamlConfig('does-not-exist.yml')
      >
      >     x = byoc.param(Key(YamlConfig, 'x'), Value(1))

    tmp_files:
      {}
    expected:
      x: 1
  -
    id: yaml-schema
    app:
      > class MyApp:
      >
      >     @byoc.configs
      >     def iter_configs(self):
      >         yield YamlConfig('x.yml', schema=star_keys)
      >
      >     x = byoc.param(Key(YamlConfig, 'x*'))
    tmp_files:
      x.yml:
        > x: 1
    expected:
      x: 1
  -
    id: yaml-root-key
    app:
      > class MyApp:
      >
      >     @byoc.configs
      >     def iter_configs(self):
      >         yield YamlConfig('x.yml', root_key='x')
      >
      >     y = byoc.param(Key(YamlConfig, 'y'))
    tmp_files:
      x.yml:
        > x:
        >   y: 1
    expected:
      y: 1
  -
    id: yaml-meta
    app:
      > class MyApp(MetaMixin):
      >
      >     @byoc.configs
      >     def iter_configs(self):
      >         yield YamlConfig('x.yml')
      >
      >     x = byoc.param(Key(YamlConfig, 'x'))
    tmp_files:
      x.yml:
        > x: 1
    expected:
      x: 1
      meta.x.path: 'x.yml'
  -
    id: yaml-relpath
    app:
      > class MyApp:
      >
      >     @byoc.configs
      >     def iter_configs(self):
      >         yield YamlConfig('path/to/conf.yml')
      >
      >     x = byoc.param(Key(YamlConfig, 'x', cast=byoc.relpath))
      >     y = byoc.param(Key(YamlConfig, 'y', cast=byoc.relpath))
    tmp_files:
      path/to/conf.yml:
        > x: README
        > y: /README
    expected:
      x: CWD / 'path/to/README'
      y: Path('/README')

test_dict_like:
  -
    f:
      > def f(x):
      >     return x + 1
    x: 1
    expected: 2
  -
    f:
      > def f(x):
      >     raise KeyError
    error:
      type: KeyError
  -
    f:
      > def f(x):
      >     raise IndexError
    raises:
      - IndexError
    error:
      type: KeyError
  -
    f:
      > def f(x):
      >     raise IndexError
    raises:
      - AttributeError
    error:
      type: IndexError
  -
    f:
      > def f(x):
      >     raise IndexError
    raises:
      - AttributeError
      - IndexError
    error:
      type: KeyError


